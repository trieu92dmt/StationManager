@model StockAllocationSearchViewModel
@{
    ViewBag.Title = LanguageResource.Reports_StockAllocationReport;
    string CurrentController = ConstController.StockAllocation;
    string CurrentArea = ConstArea.Reports;

    string CurrentUrl = HtmlExtensions.GetCurrentUrl(CurrentArea, CurrentController);
}
<div class="content-header clearfix">
    <h1 class="pull-left">
        @ViewBag.Title
    </h1>
    <div class="pull-right">
    </div>
</div>
<div class="content">
    <div class="form-horizontal">
        <div class="panel-group">
            <div class="panel panel-default panel-search">
                @using (Html.BeginForm("_Search", null, FormMethod.Post, new { @id = "frmSearch", @class = "isd-form-search" }))
                {
                    <div class="panel-body">
                        <div class="row">
                            <div class="row">

                            </div>
                            <div class="row">
                                <div class="col-md-5">
                                    <div class="form-group">
                                        <div class="col-md-4">
                                            @Html.TooltipLabelFor(p => p.BrochureEpectedQuantity)
                                        </div>
                                        <div class="col-md-8">
                                            @Html.RequiredTextboxFor(p => p.BrochureEpectedQuantity, new { @type = "number", @min = "1", @step = "1" })

                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-5">
                                    <div class="form-group">
                                        <div class="col-md-4">
                                            @Html.TooltipLabelFor(p => p.SearchCompanyId)
                                        </div>
                                        <div class="col-md-8">
                                            @Html.DropDownListFor(p => p.SearchCompanyId, null, null, new { @class = "form-control with-search" })
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-5">
                                    <div class="form-group">
                                        <div class="col-md-4">
                                            @Html.TooltipLabelFor(p => p.CatalogueExpectedQuantity)
                                        </div>
                                        <div class="col-md-8">
                                            @Html.RequiredTextboxFor(p => p.CatalogueExpectedQuantity, new { @type = "number", @min = "1", @step = "1" })

                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-5">
                                    <div class="form-group">
                                        <div class="col-md-4">
                                            @Html.TooltipLabelFor(p => p.SearchStoreId)
                                        </div>
                                        <div class="col-md-8">
                                            @Html.DropDownListFor(p => p.SearchStoreId, null, null, new { @class = "form-control with-search" })
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-5">
                                    <div class="form-group">
                                        <div class="col-md-4">
                                            @Html.TooltipLabelFor(p => p.KEExpectedQuantity)
                                        </div>
                                        <div class="col-md-8">
                                            @Html.RequiredTextboxFor(p => p.KEExpectedQuantity, new { @type = "number", @min = "1", @step = "1" })

                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-5">
                                    <div class="form-group">
                                        <div class="col-md-4">
                                            @Html.TooltipLabelFor(p => p.SearchFromDate)
                                        </div>
                                        <div class="col-md-8">
                                            @Html.RequiredTextboxFor(p => p.SearchFromDate, new { type = "date" })
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-5">
                                    <div class="form-group">
                                        <div class="col-md-4">
                                            @Html.TooltipLabelFor(p => p.PackagingExpectedQuantity)
                                        </div>
                                        <div class="col-md-8">
                                            @Html.RequiredTextboxFor(p => p.PackagingExpectedQuantity, new { @type = "number", @min = "1", @step = "1" })

                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-5">
                                    <div class="form-group">
                                        <div class="col-md-4">
                                            @Html.TooltipLabelFor(p => p.SearchToDate)
                                        </div>
                                        <div class="col-md-8">
                                            @Html.RequiredTextboxFor(p => p.SearchToDate, new { type = "date" })
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-5">
                                    <div class="form-group">
                                        <div class="col-md-4">
                                            @Html.TooltipLabelFor(p => p.SampleExpectedQuantity)
                                        </div>
                                        <div class="col-md-8">
                                            @Html.RequiredTextboxFor(p => p.SampleExpectedQuantity, new { @type = "number", @min = "1", @step = "1" })

                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-12">
                            <div class="form-group">
                                <div class="col-md-3 col-md-offset-4 input-group">
                                    <select class="form-control" id="SearchTemplateId" name="SearchTemplateId">
                                        <option value="">@LanguageResource.Dropdownlist_RecentSearch</option>
                                    </select>
                                    <span class="input-group-btn" style="padding-right:25px;padding-left: 10px;">
                                        <a class="btn btn-delete-frmSearch display-none" style="color: coral;" title="Xoá mẫu tìm kiếm"><i class="fa fa-trash-o fa-lg" aria-hidden="true"></i></a>
                                        <a class="btn btn-save-frmSearch" title="Lưu mẫu tìm kiếm"><i class="fa fa-thumb-tack fa-lg" aria-hidden="true"></i></a>
                                    </span>
                                    <a class="btn btn-success" id="btn-export"><i class="fa fa-download"></i> Export</a>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>

        </div>
    </div>
</div>

<div class="delete-confirm"></div>
@section jquery {
    <link href="~/Content/jquery-ui.css" rel="stylesheet" />
    <script src="~/Content/jquery-ui.js"></script>
}


@section scripts {
    <script src="~/Scripts/Common/ISD.SearchTemplate.js"></script>
    <script>
	//Define it
	var currentUserId = "@CurrentUser.AccountId";
	var currentPageId = "@ViewBag.PageId";
    </script>
    <script>
        $(document).ready(function () {
            //Set lại thông tin search gần đây khi là back lại
            var modeTemplateSearch = ISD.GetQueryString("ModeSearch", window.location.href);

            if (modeTemplateSearch == "Recently") {
                LoadTemplateSearch(currentUserId, currentPageId, "Recently");
                var recentSearch = JSON.parse(localStorage.getItem('pageId-' + currentPageId));
                if (recentSearch) {
                    FillToInput(recentSearch);
                }
            } else {
                LoadTemplateSearch(currentUserId, currentPageId);
                localStorage.removeItem('pageId-' + currentPageId)
            }
        })
         $(document).on("click", "#btn-export", function () {
            var $btn = $(this);
             var frm = $("#frmSearch");
             if (frm.valid()) {
                 var arr = {};
                 var data = $("#frmSearch").serializeArray();
                 $.each(data, function (index, val) {
                     var obj = {};
                     obj[val.name] = val.value;
                     $.extend(true, arr, obj)
                 });
                 var searchData = GetDataFormSearch();
                 //Save localStorage
                 localStorage.setItem('pageId-' + currentPageId, searchData);
                 ISD.Download("/@CurrentUrl/ExportExcel", arr);
             }
             else {
                 var validator = frm.validate();
                 var arr = [];
                 $.each(validator.errorMap, function (index, value) {
                     console.log('Id: ' + index + ' Message: ' + value);
                     arr.push(value);
                 });
                 if (arr.length > 0) {
                     alertPopup(false, arr);
                 }
             }

        });
         $(document).on("change", "select[name='SearchCompanyId']", function () {
            var CompanyId = $(this).val();
            if (CompanyId == "") {
                $.ajax({
                    type: "POST",
                    url: "/MasterData/Store/GetAllStoreForDropDown",
                    success: function (jsonData) {
                        $("#SearchStoreId").html("");

                        $.each(jsonData, function (index, value) {
                            $("#SearchStoreId").append("<option value='" + value.Value + "'>" + value.Text + "</option>");
                        });
                        $("#SearchStoreId").trigger("change");
                    }
                });

            } else {
                $.ajax({
                    type: "POST",
                    url: "/MasterData/Store/GetStoreByCompany",
                    data: {
                        CompanyId: CompanyId
                    },
                    success: function (jsonData) {
                        $("#SearchStoreId").html("");
                        $.each(jsonData, function (index, value) {
                            $("#SearchStoreId").append("<option value='" + value.Value + "'>" + value.Text + "</option>");
                        });
                        $("#SearchStoreId").trigger("change");
                    }
                });

            }
        });
    </script>
    <script>
        //Get data of form search name function is required
        function GetDataFormSearch() {
            //Get value in search form
            var formdata = $("#frmSearch").serializeArray();
            var data = {};
            $(formdata).each(function (index, obj) {
                data[obj.name] = obj.value;
            });
            return JSON.stringify(data);
        }
    </script>
}

