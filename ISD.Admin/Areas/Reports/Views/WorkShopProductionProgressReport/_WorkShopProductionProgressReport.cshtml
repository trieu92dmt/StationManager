@using Newtonsoft.Json;
@model IEnumerable<WorkShopProductionProgressReportViewModel>
@{
    var pivotSetting = (List<FieldSettingModel>)ViewBag.PivotSetting;
    var search = (WorkShopProductionProgressReportSearchViewModel)ViewBag.Search;
}
@Html.DevExpress().PivotGrid(settings =>
{
    settings.Name = "CustomerTastesPivotGrid";
    settings.CallbackRouteValues = new { Controller = "WorkShopProductionProgressReport", Action = "WorkShopProductionProgressReportPartial", jsonReq = JsonConvert.SerializeObject(search) };
    settings.Width = Unit.Percentage(90);
    settings.OptionsPager.RowsPerPage = 20;
    settings.OptionsPager.PageSizeItemSettings.Visible = true;
    settings.OptionsCustomization.AllowDrag = true;
    settings.OptionsCustomization.AllowDragInCustomizationForm = true;
    settings.CustomizationFieldsLeft = 600;
    settings.CustomizationFieldsTop = 400;
    settings.OptionsCustomization.AllowSort = false;
    settings.AfterPerformCallback = (sender, e) =>
    {
        List<FieldSettingModel> fieldSettingList = new List<FieldSettingModel>();
        ASPxPivotGrid PivotGrid = sender as ASPxPivotGrid;
        var listField = PivotGrid.Fields;
        foreach (PivotGridField field in listField)
        {
            FieldSettingModel fieldSetting = new FieldSettingModel();
            fieldSetting.Caption = field.Caption;
            fieldSetting.AreaIndex = field.AreaIndex;
            fieldSetting.FieldName = field.FieldName;
            if (field.Area == PivotArea.RowArea)
            {
                fieldSetting.PivotArea = 0;

            }
            else
            {
                if (field.Area == PivotArea.ColumnArea)
                {
                    fieldSetting.PivotArea = 1;
                }
                else
                {
                    if (field.Area == PivotArea.FilterArea)
                    {
                        fieldSetting.PivotArea = 2;
                    }
                    else
                    {
                        fieldSetting.PivotArea = 3;
                    }
                }
            }
            if (field.ValueFormat.FormatType == FormatType.Numeric || field.ValueFormat.FormatType == FormatType.DateTime)
            {
                fieldSetting.CellFormat_FormatString = field.ValueFormat.FormatString;
                fieldSetting.CellFormat_FormatType = field.ValueFormat.FormatType.ToString();
            }
            fieldSetting.Visible = field.Visible;
            fieldSettingList.Add(fieldSetting);
        }
        Session[CurrentUser.AccountId + "Layout"] = fieldSettingList;

    };

    if (pivotSetting != null && pivotSetting.Count > 0)
    {
        foreach (var fieldSetting in pivotSetting)
        {
            settings.Fields.Add(field =>
            {
                if (fieldSetting.PivotArea == 0)
                {
                    field.Area = PivotArea.RowArea;
                }
                if (fieldSetting.PivotArea == 1)
                {
                    field.Area = PivotArea.ColumnArea;
                }
                if (fieldSetting.PivotArea == 2)
                {
                    if (fieldSetting.AreaIndex > 10)
                    {
                        field.Visible = false;
                    }
                    field.Area = PivotArea.FilterArea;
                }
                if (fieldSetting.PivotArea == 3)
                {
                    field.Area = PivotArea.DataArea;
                }
                field.FieldName = fieldSetting.FieldName;
                field.Caption = fieldSetting.Caption;
                field.AreaIndex = fieldSetting.AreaIndex.Value;
                if (fieldSetting.CellFormat_FormatType == "DateTime")
                {
                    field.ValueFormat.FormatType = FormatType.DateTime;
                    field.ValueFormat.FormatString = fieldSetting.CellFormat_FormatString;
                    field.CellFormat.FormatType = FormatType.DateTime;
                    field.CellFormat.FormatString = fieldSetting.CellFormat_FormatString;
                }
                if (fieldSetting.CellFormat_FormatType == "Numeric")
                {
                    field.ValueFormat.FormatType = FormatType.Numeric;
                    field.ValueFormat.FormatString = fieldSetting.CellFormat_FormatString;
                    field.CellFormat.FormatType = FormatType.Numeric;
                    field.CellFormat.FormatString = fieldSetting.CellFormat_FormatString;
                    field.CellStyle.HorizontalAlign = HorizontalAlign.Right;
                    field.ValueStyle.HorizontalAlign = HorizontalAlign.Right;
                }
                field.Visible = fieldSetting.Visible.Value;
            });
        }
    }
    else // default
    {

        //Row Area

        settings.Fields.Add(field =>
        {
            field.Area = PivotArea.RowArea;
            field.FieldName = "LSXSAP";
            field.Caption = "Lô Sản Xuất SAP";
            field.AreaIndex = 1;
        });
        settings.Fields.Add(field =>
        {
            field.Area = PivotArea.RowArea;
            field.FieldName = "LSX";
            field.Caption = "Lô Sản Xuất";
            field.AreaIndex = 2;
        });
        settings.Fields.Add(field =>
        {
            field.Area = PivotArea.RowArea;
            field.FieldName = "MaSP";
            field.Caption = "Mã Sản Phẩm";
            field.AreaIndex = 3;
        });
        settings.Fields.Add(field =>
        {
            field.Area = PivotArea.RowArea;
            field.FieldName = "TenSP";
            field.Caption = "Tên Sản Phẩm ";
            field.AreaIndex = 4;
        });
        settings.Fields.Add(field =>
        {
            field.Area = PivotArea.RowArea;
            field.FieldName = "MaNVLSAP";
            field.Caption = "Mã Nhiên Vật Liệu SAP ";
            field.AreaIndex = 5;
        });
        settings.Fields.Add(field =>
        {
            field.Area = PivotArea.RowArea;
            field.FieldName = "NL";
            field.Caption = "Nguyên Liệu";
            field.AreaIndex = 6;
        });
        settings.Fields.Add(field =>
        {
            field.Area = PivotArea.RowArea;
            field.FieldName = "DonVi";
            field.Caption = "Đơn Vị";
            field.AreaIndex = 7;
        });
        settings.Fields.Add(field =>
        {
            field.Area = PivotArea.RowArea;
            field.FieldName = "SLCT";
            field.Caption = "Số Lượng Chi Tiết";
            field.AreaIndex = 8;
        });
        settings.Fields.Add(field =>
        {
            field.Area = PivotArea.RowArea;
            field.FieldName = "Day";
            field.Caption = "Dày";
            field.AreaIndex = 9;

        });
        settings.Fields.Add(field =>
        {
            field.Area = PivotArea.RowArea;
            field.FieldName = "Rong";
            field.Caption = "Rộng";
            field.AreaIndex = 10;

        });
        settings.Fields.Add(field =>
        {
            field.Area = PivotArea.RowArea;
            field.FieldName = "Dai";
            field.Caption = "Dài";
            field.AreaIndex = 11;

        });
        settings.Fields.Add(field =>
        {
            field.Area = PivotArea.RowArea;
            field.FieldName = "Day";
            field.Caption = "Dày";
            field.AreaIndex = 12;

        });
        settings.Fields.Add(field =>
        {
            field.Area = PivotArea.RowArea;
            field.FieldName = "SLCTKH";
            field.Caption = "SLChi Tiết Khách Hàng";
            field.AreaIndex = 13;

        });
        settings.Fields.Add(field =>
        {
            field.Area = PivotArea.RowArea;
            field.FieldName = "MaNhomNL";
            field.Caption = "Mã Nhóm Nguyên Liệu";
            field.AreaIndex = 14;

        });
        settings.Fields.Add(field =>
        {
            field.Area = PivotArea.RowArea;
            field.FieldName = "KLTinhKH";
            field.Caption = "Khối Lượng Tinh KH";
            field.AreaIndex = 15;

        });
        settings.Fields.Add(field =>
        {
            field.Area = PivotArea.RowArea;
            field.FieldName = "SoChe";
            field.Caption = "Sơ Chế";
            field.AreaIndex = 16;

        });
        settings.Fields.Add(field =>
        {
            field.Area = PivotArea.RowArea;
            field.FieldName = "TinChe";
            field.Caption = "Tinh Chế";
            field.AreaIndex = 17;

        });
        settings.Fields.Add(field =>
        {
            field.Area = PivotArea.RowArea;
            field.FieldName = "Rap";
            field.Caption = "Ráp";
            field.AreaIndex = 18;

        });
        settings.Fields.Add(field =>
        {
            field.Area = PivotArea.RowArea;
            field.FieldName = "SoCheHT";
            field.Caption = "Sơ Chế Hoàn Thiện";
            field.AreaIndex = 19;

        });
        settings.Fields.Add(field =>
        {
            field.Area = PivotArea.RowArea;
            field.FieldName = "TinhCheHT";
            field.Caption = "Tinh Chế Hoàn Thiện";
            field.AreaIndex = 20;

        });
        settings.Fields.Add(field =>
        {
            field.Area = PivotArea.RowArea;
            field.FieldName = "RapHT";
            field.Caption = "Ráp Hoàn Thiện";
            field.AreaIndex = 21;

        });
        settings.Fields.Add(field =>
        {
            field.Area = PivotArea.RowArea;
            field.FieldName = "HT";
            field.Caption = "Hoàn Thiện";
            field.AreaIndex = 22;

        });

    }

}).Bind(Model).GetHtml()